<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CycleTracker - Bike Riding App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" id="app-manifest">
    <meta name="theme-color" content="#3b82f6">
    <style>
        /* Custom styles for neumorphism and other effects */
        .neumorph {
            border-radius: 16px;
            background: #f0f0f0;
            box-shadow: 8px 8px 16px #d9d9d9, -8px -8px 16px #ffffff;
        }
        
        .neumorph-inset {
            border-radius: 16px;
            background: #f0f0f0;
            box-shadow: inset 8px 8px 16px #d9d9d9, inset -8px -8px 16px #ffffff;
        }
        
        .neumorph-dark {
            border-radius: 16px;
            background: #1f2937;
            box-shadow: 8px 8px 16px #1a202c, -8px -8px 16px #242e3d;
        }
        
        .neumorph-inset-dark {
            border-radius: 16px;
            background: #1f2937;
            box-shadow: inset 8px 8px 16px #1a202c, inset -8px -8px 16px #242e3d;
        }
        
        .tab-active {
            color: #3b82f6;
        }
        
        .dark .tab-active {
            color: #60a5fa;
        }
        
        /* Animation for the pulse effect */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        /* Map styling */
        #map {
            height: 250px;
            width: 100%;
            border-radius: 16px;
        }
        
        /* Hide map when no GPS */
        .no-gps #map {
            display: none;
        }
        
        /* Manual input styling */
        .manual-input {
            display: none;
        }
        
        .no-gps .manual-input {
            display: block;
        }
        
        /* Install button styling */
        #installButton {
            display: none;
        }
        
        /* Service worker ready */
        .sw-ready #installButton {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
    <div class="max-w-md mx-auto min-h-screen flex flex-col bg-white dark:bg-gray-800">
        <!-- Header -->
        <header class="p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600 dark:text-blue-400">CycleTracker</h1>
            <div class="flex items-center space-x-2">
                <button id="installButton" class="p-2 rounded-full neumorph dark:neumorph-dark text-green-600 dark:text-green-400">
                    <i class="fas fa-download"></i>
                </button>
                <button id="themeToggle" class="p-2 rounded-full neumorph dark:neumorph-dark">
                    <i class="fas fa-moon text-gray-700 dark:text-yellow-300"></i>
                </button>
            </div>
        </header>
        
        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto px-4 pb-20">
            <!-- Ride Tab Content -->
            <div id="rideTab" class="tab-content">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="neumorph-inset dark:neumorph-inset-dark p-4 text-center">
                        <p class="text-gray-500 dark:text-gray-400">Distance</p>
                        <p id="distance" class="text-2xl font-bold">0.0 km</p>
                    </div>
                    <div class="neumorph-inset dark:neumorph-inset-dark p-4 text-center">
                        <p class="text-gray-500 dark:text-gray-400">Duration</p>
                        <p id="duration" class="text-2xl font-bold">00:00:00</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="neumorph-inset dark:neumorph-inset-dark p-4 text-center">
                        <p class="text-gray-500 dark:text-gray-400">Avg Speed</p>
                        <p id="avgSpeed" class="text-2xl font-bold">0.0 km/h</p>
                    </div>
                    <div class="neumorph-inset dark:neumorph-inset-dark p-4 text-center">
                        <p class="text-gray-500 dark:text-gray-400">Calories</p>
                        <p id="calories" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                
                <!-- Map Container -->
                <div id="map" class="mb-4">
                    <!-- Map will be rendered here -->
                    <div class="h-full w-full flex items-center justify-center bg-gray-200 dark:bg-gray-700 rounded-lg">
                        <p class="text-gray-500">Loading map...</p>
                    </div>
                </div>
                
                <!-- Manual Input (shown when no GPS) -->
                <div class="manual-input mb-4">
                    <div class="neumorph-inset dark:neumorph-inset-dark p-4">
                        <h3 class="font-bold mb-2 text-gray-700 dark:text-gray-300">Manual Ride Logging</h3>
                        <div class="mb-2">
                            <label class="block text-sm text-gray-600 dark:text-gray-400">Duration (minutes)</label>
                            <input type="number" id="manualDuration" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white" value="30">
                        </div>
                        <div class="mb-2">
                            <label class="block text-sm text-gray-600 dark:text-gray-400">Distance (km)</label>
                            <input type="number" id="manualDistance" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white" value="5.0" step="0.1">
                        </div>
                    </div>
                </div>
                
                <!-- Control Buttons -->
                <div class="flex justify-center space-x-4 mt-6">
                    <button id="startBtn" class="neumorph dark:neumorph-dark px-6 py-3 rounded-full text-green-600 dark:text-green-400 pulse-animation">
                        <i class="fas fa-play-circle text-2xl"></i>
                        <span class="ml-2">Start</span>
                    </button>
                    <button id="pauseBtn" disabled class="neumorph dark:neumorph-dark px-6 py-3 rounded-full text-yellow-600 dark:text-yellow-400 opacity-50">
                        <i class="fas fa-pause-circle text-2xl"></i>
                        <span class="ml-2">Pause</span>
                    </button>
                    <button id="stopBtn" disabled class="neumorph dark:neumorph-dark px-6 py-3 rounded-full text-red-600 dark:text-red-400 opacity-50">
                        <i class="fas fa-stop-circle text-2xl"></i>
                        <span class="ml-2">Stop</span>
                    </button>
                </div>
                
                <!-- GPS Status -->
                <div id="gpsStatus" class="mt-4 p-2 text-center text-sm neumorph-inset dark:neumorph-inset-dark">
                    <i class="fas fa-satellite text-blue-500"></i>
                    <span class="ml-2">Searching for GPS signal...</span>
                </div>
            </div>
            
            <!-- History Tab Content -->
            <div id="historyTab" class="tab-content hidden">
                <h2 class="text-xl font-bold mb-4 text-gray-700 dark:text-gray-300">Ride History</h2>
                <div id="ridesList" class="space-y-4">
                    <!-- Ride history items will be added here -->
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-bicycle text-4xl mb-2"></i>
                        <p>No rides recorded yet</p>
                    </div>
                </div>
            </div>
            
            <!-- Leaderboard Tab Content -->
            <div id="leaderboardTab" class="tab-content hidden">
                <h2 class="text-xl font-bold mb-4 text-gray-700 dark:text-gray-300">Weekly Leaderboard</h2>
                <div class="neumorph-inset dark:neumorph-inset-dark p-4 mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium">Your Weekly Distance:</span>
                        <span id="weeklyDistance" class="font-bold">0.0 km</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4">
                        <div id="progressBar" class="bg-blue-600 h-4 rounded-full" style="width: 0%"></div>
                    </div>
                    <p class="text-xs mt-2 text-gray-500 dark:text-gray-400">Goal: 50 km</p>
                </div>
                
                <div id="leaderboardList" class="space-y-2">
                    <!-- Leaderboard items will be added here -->
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-trophy text-4xl mb-2"></i>
                        <p>No leaderboard data yet</p>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab Content -->
            <div id="settingsTab" class="tab-content hidden">
                <h2 class="text-xl font-bold mb-4 text-gray-700 dark:text-gray-300">Settings</h2>
                
                <div class="neumorph-inset dark:neumorph-inset-dark p-4 mb-4">
                    <h3 class="font-medium mb-2">App Settings</h3>
                    
                    <div class="flex justify-between items-center mb-4">
                        <span>Dark Mode</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="darkModeToggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block mb-1">Weight (kg)</label>
                        <input type="number" id="weightInput" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white" value="70">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block mb-1">Distance Unit</label>
                        <select id="unitSelect" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white">
                            <option value="km">Kilometers (km)</option>
                            <option value="mi">Miles (mi)</option>
                        </select>
                    </div>
                </div>
                
                <div class="neumorph-inset dark:neumorph-inset-dark p-4 mb-4">
                    <h3 class="font-medium mb-2">Data Management</h3>
                    
                    <button id="exportBtn" class="w-full mb-2 py-2 px-4 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                        <i class="fas fa-download mr-2"></i> Export Ride Data
                    </button>
                    
                    <button id="clearBtn" class="w-full py-2 px-4 bg-red-500 text-white rounded hover:bg-red-600 transition">
                        <i class="fas fa-trash mr-2"></i> Clear All Data
                    </button>
                </div>
                
                <div class="text-center text-sm text-gray-500 dark:text-gray-400 mt-8">
                    <p>CycleTracker v1.0.0</p>
                    <p>PWA Cycling App</p>
                </div>
            </div>
        </main>
        
        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
            <div class="max-w-md mx-auto flex justify-around">
                <button class="tab-btn tab-active py-3 px-6 text-center" data-tab="rideTab">
                    <i class="fas fa-bicycle block text-xl"></i>
                    <span class="text-xs mt-1">Ride</span>
                </button>
                <button class="tab-btn py-3 px-6 text-center" data-tab="historyTab">
                    <i class="fas fa-history block text-xl"></i>
                    <span class="text-xs mt-1">History</span>
                </button>
                <button class="tab-btn py-3 px-6 text-center" data-tab="leaderboardTab">
                    <i class="fas fa-trophy block text-xl"></i>
                    <span class="text-xs mt-1">Leaderboard</span>
                </button>
                <button class="tab-btn py-3 px-6 text-center" data-tab="settingsTab">
                    <i class="fas fa-cog block text-xl"></i>
                    <span class="text-xs mt-1">Settings</span>
                </button>
            </div>
        </nav>
    </div>

    <script>
        // App State
        const state = {
            isTracking: false,
            isPaused: false,
            startTime: null,
            pausedTime: 0,
            totalPausedTime: 0,
            currentPosition: null,
            positions: [],
            totalDistance: 0,
            timerInterval: null,
            gpsAvailable: false,
            weight: 70, // Default weight in kg
            unit: 'km', // Default unit
            darkMode: false
        };

        // DOM Elements
        const elements = {
            distance: document.getElementById('distance'),
            duration: document.getElementById('duration'),
            avgSpeed: document.getElementById('avgSpeed'),
            calories: document.getElementById('calories'),
            startBtn: document.getElementById('startBtn'),
            pauseBtn: document.getElementById('pauseBtn'),
            stopBtn: document.getElementById('stopBtn'),
            gpsStatus: document.getElementById('gpsStatus'),
            themeToggle: document.getElementById('themeToggle'),
            darkModeToggle: document.getElementById('darkModeToggle'),
            weightInput: document.getElementById('weightInput'),
            unitSelect: document.getElementById('unitSelect'),
            manualDuration: document.getElementById('manualDuration'),
            manualDistance: document.getElementById('manualDistance'),
            ridesList: document.getElementById('ridesList'),
            leaderboardList: document.getElementById('leaderboardList'),
            weeklyDistance: document.getElementById('weeklyDistance'),
            progressBar: document.getElementById('progressBar'),
            installButton: document.getElementById('installButton')
        };

        // Initialize the app
        function initApp() {
            setupManifest();
            loadSettings();
            setupEventListeners();
            checkGPSAvailability();
            updateHistoryList();
            updateLeaderboard();
            registerServiceWorker();
            setupPWAInstall();
        }

        // Set up the web app manifest
        function setupManifest() {
            const manifest = {
                "name": "CycleTracker",
                "short_name": "CycleTracker",
                "description": "A cycling app that tracks your rides with GPS",
                "start_url": "/",
                "display": "standalone",
                "background_color": "#3b82f6",
                "theme_color": "#3b82f6",
                "orientation": "portrait",
                "icons": [
                    {
                        "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGNpcmNsZSBjeD0iOTYiIGN5PSI5NiIgcj0iOTYiIGZpbGw9IiMzYjgzZjYiLz4KICA8cGF0aCBkPSJNMTI4IDcySDEwNFYxMjBINzJWNzJINDBWMTIwQzQwIDEzNC4zMjggNTEuNjcyIDE0NiA2NiAxNDZIMTI2QzE0MC4zMjggMTQ2IDE1MiAxMzQuMzI4IDE1MiAxMjBWOTBDMTUyIDgwLjA1ODQgMTQzLjk0MiA3MiAxMzQgNzJIMTI4WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cg==",
                        "sizes": "192x192",
                        "type": "image/svg+xml"
                    },
                    {
                        "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGNpcmNsZSBjeD0iMjU2IiBjeT0iMjU2IiByPSIyNTYiIGZpbGw9IiMzYjgzZjYiLz4KICA8cGF0aCBkPSJNMzQxLjMzMyAyMTBIMjc3LjMzM1YzMjBIMTkyVjIxMEgxMDYuNjY3VjMyMEMxMDYuNjY3IDM1OC4zMDUgMTM3LjYyMiAzOTAgMTc2IDM5MEgzMzZDMzc0LjM3OCAzOTAgNDA1LjMzMyAzNTguMzA1IDQwNS4zMzMgMzIwVjI0MEM0MDUuMzMzIDIyNC43NjIgMzk0LjU3MSAyMTIgMzgxLjMzMyAyMTJIMzQxLjMzM1oiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=",
                        "sizes": "512x512",
                        "type": "image/svg+xml"
                    }
                ]
            };

            const manifestURL = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'}));
            document.getElementById('app-manifest').href = manifestURL;
        }

        // Register service worker for PWA functionality
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swCode = `
                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open('cycler-tracker-v1').then((cache) => {
                                return cache.addAll([
                                    '/',
                                    '/index.html',
                                    '/styles.css',
                                    '/app.js'
                                ]);
                            })
                        );
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request).then((response) => {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `;

                const swBlob = new Blob([swCode], {type: 'application/javascript'});
                const swURL = URL.createObjectURL(swBlob);

                navigator.serviceWorker.register(swURL)
                    .then(() => {
                        console.log('Service Worker registered successfully');
                        document.body.classList.add('sw-ready');
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            }
        }

        // Set up PWA install prompt
        function setupPWAInstall() {
            let deferredPrompt;
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                elements.installButton.addEventListener('click', () => {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                        }
                        deferredPrompt = null;
                    });
                });
            });
        }

        // Set up event listeners
        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // Control buttons
            elements.startBtn.addEventListener('click', startRide);
            elements.pauseBtn.addEventListener('click', togglePause);
            elements.stopBtn.addEventListener('click', stopRide);

            // Theme toggle
            elements.themeToggle.addEventListener('click', toggleDarkMode);
            elements.darkModeToggle.addEventListener('change', toggleDarkMode);

            // Settings changes
            elements.weightInput.addEventListener('change', saveSettings);
            elements.unitSelect.addEventListener('change', saveSettings);

            // Data management
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('clearBtn').addEventListener('click', clearData);
        }

        // Check if GPS is available
        function checkGPSAvailability() {
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    () => {
                        state.gpsAvailable = true;
                        elements.gpsStatus.innerHTML = '<i class="fas fa-satellite text-green-500"></i><span class="ml-2">GPS signal acquired</span>';
                        document.body.classList.remove('no-gps');
                    },
                    () => {
                        state.gpsAvailable = false;
                        elements.gpsStatus.innerHTML = '<i class="fas fa-satellite text-red-500"></i><span class="ml-2">GPS unavailable - using manual mode</span>';
                        document.body.classList.add('no-gps');
                    }
                );
            } else {
                state.gpsAvailable = false;
                elements.gpsStatus.innerHTML = '<i class="fas fa-satellite text-red-500"></i><span class="ml-2">GPS not supported - using manual mode</span>';
                document.body.classList.add('no-gps');
            }
        }

        // Start a new ride
        function startRide() {
            if (state.isTracking) return;
            
            state.isTracking = true;
            state.startTime = new Date();
            state.positions = [];
            state.totalDistance = 0;
            state.totalPausedTime = 0;
            state.pausedTime = 0;
            
            // Update UI
            elements.startBtn.disabled = true;
            elements.pauseBtn.disabled = false;
            elements.stopBtn.disabled = false;
            elements.startBtn.classList.remove('pulse-animation');
            elements.pauseBtn.classList.remove('opacity-50');
            elements.stopBtn.classList.remove('opacity-50');
            
            // Start timer
            startTimer();
            
            // Start tracking position if GPS available
            if (state.gpsAvailable) {
                state.watchId = navigator.geolocation.watchPosition(
                    updatePosition,
                    handlePositionError,
                    { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
                );
            }
        }

        // Toggle pause/resume
        function togglePause() {
            if (!state.isTracking) return;
            
            if (state.isPaused) {
                // Resume tracking
                state.isPaused = false;
                state.totalPausedTime += (Date.now() - state.pausedTime);
                elements.pauseBtn.innerHTML = '<i class="fas fa-pause-circle text-2xl"></i><span class="ml-2">Pause</span>';
                
                // Resume GPS tracking if available
                if (state.gpsAvailable) {
                    state.watchId = navigator.geolocation.watchPosition(
                        updatePosition,
                        handlePositionError,
                        { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
                    );
                }
            } else {
                // Pause tracking
                state.isPaused = true;
                state.pausedTime = Date.now();
                elements.pauseBtn.innerHTML = '<i class="fas fa-play-circle text-2xl"></i><span class="ml-2">Resume</span>';
                
                // Stop GPS tracking to save battery
                if (state.gpsAvailable) {
                    navigator.geolocation.clearWatch(state.watchId);
                }
            }
        }

        // Stop the current ride
        function stopRide() {
            if (!state.isTracking) return;
            
            state.isTracking = false;
            
            // Stop GPS tracking
            if (state.gpsAvailable) {
                navigator.geolocation.clearWatch(state.watchId);
            }
            
            // Stop timer
            clearInterval(state.timerInterval);
            
            // Calculate ride stats
            const endTime = new Date();
            const duration = (endTime - state.startTime - state.totalPausedTime) / 1000;
            const avgSpeed = duration > 0 ? state.totalDistance / (duration / 3600) : 0;
            
            // Calculate calories (MET value for cycling = 8)
            const met = 8;
            const caloriesBurned = Math.round(met * state.weight * (duration / 3600));
            
            // If no GPS, use manual input
            let finalDistance = state.totalDistance;
            if (!state.gpsAvailable) {
                finalDistance = parseFloat(elements.manualDistance.value) || 0;
            }
            
            // Save ride to history
            saveRide({
                date: state.startTime.toISOString(),
                duration: duration,
                distance: finalDistance,
                avgSpeed: avgSpeed,
                calories: caloriesBurned,
                positions: state.positions
            });
            
            // Reset UI
            resetUI();
            
            // Update history and leaderboard
            updateHistoryList();
            updateLeaderboard();
        }

        // Update position from GPS
        function updatePosition(position) {
            if (!state.isTracking || state.isPaused) return;
            
            state.currentPosition = position;
            
            // Add to positions array
            if (state.positions.length > 0) {
                const lastPosition = state.positions[state.positions.length - 1];
                const distance = calculateDistance(
                    lastPosition.coords.latitude,
                    lastPosition.coords.longitude,
                    position.coords.latitude,
                    position.coords.longitude
                );
                state.totalDistance += distance;
            }
            
            state.positions.push(position);
            
            // Update UI
            updateStats();
        }

        // Handle GPS errors
        function handlePositionError(error) {
            console.error('GPS Error:', error);
            elements.gpsStatus.innerHTML = `<i class="fas fa-exclamation-triangle text-red-500"></i><span class="ml-2">GPS error: ${error.message}</span>`;
        }

        // Calculate distance between two coordinates (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c; // Distance in km
            return state.unit === 'mi' ? distance * 0.621371 : distance;
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        // Start the timer
        function startTimer() {
            clearInterval(state.timerInterval);
            updateStats();
            
            state.timerInterval = setInterval(() => {
                if (!state.isPaused) {
                    updateStats();
                }
            }, 1000);
        }

        // Update statistics display
        function updateStats() {
            const now = new Date();
            const elapsedMs = state.isPaused ? 
                state.pausedTime - state.startTime - state.totalPausedTime : 
                now - state.startTime - state.totalPausedTime;
            
            // Format duration
            const hours = Math.floor(elapsedMs / 3600000);
            const minutes = Math.floor((elapsedMs % 3600000) / 60000);
            const seconds = Math.floor((elapsedMs % 60000) / 1000);
            elements.duration.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Calculate average speed
            const hoursElapsed = elapsedMs / 3600000;
            const avgSpeed = hoursElapsed > 0 ? state.totalDistance / hoursElapsed : 0;
            elements.avgSpeed.textContent = `${avgSpeed.toFixed(1)} ${state.unit}/h`;
            
            // Update distance
            elements.distance.textContent = `${state.totalDistance.toFixed(2)} ${state.unit}`;
            
            // Calculate calories (MET value for cycling = 8)
            const met = 8;
            const caloriesBurned = Math.round(met * state.weight * hoursElapsed);
            elements.calories.textContent = caloriesBurned;
        }

        // Reset UI after ride
        function resetUI() {
            elements.startBtn.disabled = false;
            elements.pauseBtn.disabled = true;
            elements.stopBtn.disabled = true;
            elements.pauseBtn.classList.add('opacity-50');
            elements.stopBtn.classList.add('opacity-50');
            elements.startBtn.classList.add('pulse-animation');
            
            elements.distance.textContent = `0.0 ${state.unit}`;
            elements.duration.textContent = '00:00:00';
            elements.avgSpeed.textContent = `0.0 ${state.unit}/h`;
            elements.calories.textContent = '0';
            
            elements.pauseBtn.innerHTML = '<i class="fas fa-pause-circle text-2xl"></i><span class="ml-2">Pause</span>';
        }

        // Switch between tabs
        function switchTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected tab
            document.getElementById(tabId).classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
            });
            
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('tab-active');
        }

        // Toggle dark mode
        function toggleDarkMode() {
            if (elements.darkModeToggle) {
                state.darkMode = elements.darkModeToggle.checked;
            } else {
                state.darkMode = !state.darkMode;
            }
            
            if (state.darkMode) {
                document.documentElement.classList.add('dark');
                elements.themeToggle.innerHTML = '<i class="fas fa-sun text-yellow-300"></i>';
                if (elements.darkModeToggle) elements.darkModeToggle.checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                elements.themeToggle.innerHTML = '<i class="fas fa-moon text-gray-700"></i>';
                if (elements.darkModeToggle) elements.darkModeToggle.checked = false;
            }
            
            saveSettings();
        }

        // Save ride to history
        function saveRide(rideData) {
            let rides = JSON.parse(localStorage.getItem('cycleTrackerRides') || '[]');
            rides.push(rideData);
            localStorage.setItem('cycleTrackerRides', JSON.stringify(rides));
        }

        // Update ride history list
        function updateHistoryList() {
            const rides = JSON.parse(localStorage.getItem('cycleTrackerRides') || '[]');
            
            if (rides.length === 0) {
                elements.ridesList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-bicycle text-4xl mb-2"></i>
                        <p>No rides recorded yet</p>
                    </div>
                `;
                return;
            }
            
            elements.ridesList.innerHTML = '';
            rides.reverse().forEach((ride, index) => {
                const rideDate = new Date(ride.date);
                const hours = Math.floor(ride.duration / 3600);
                const minutes = Math.floor((ride.duration % 3600) / 60);
                const seconds = Math.floor(ride.duration % 60);
                
                const rideElement = document.createElement('div');
                rideElement.className = 'neumorph dark:neumorph-dark p-4';
                rideElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold">${rideDate.toLocaleDateString()}</h3>
                            <p class="text-sm text-gray-500">${rideDate.toLocaleTimeString()}</p>
                        </div>
                        <span class="text-blue-600 dark:text-blue-400 font-bold">${ride.distance.toFixed(2)} ${state.unit}</span>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mt-2 text-sm">
                        <div>
                            <p class="text-gray-500">Time</p>
                            <p>${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Avg Speed</p>
                            <p>${ride.avgSpeed.toFixed(1)} ${state.unit}/h</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Calories</p>
                            <p>${ride.calories}</p>
                        </div>
                    </div>
                `;
                
                elements.ridesList.appendChild(rideElement);
            });
        }

        // Update leaderboard
        function updateLeaderboard() {
            const rides = JSON.parse(localStorage.getItem('cycleTrackerRides') || '[]');
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            // Calculate weekly distance
            const weeklyDistance = rides.reduce((total, ride) => {
                const rideDate = new Date(ride.date);
                return rideDate >= oneWeekAgo ? total + ride.distance : total;
            }, 0);
            
            elements.weeklyDistance.textContent = `${weeklyDistance.toFixed(2)} ${state.unit}`;
            
            // Update progress bar (goal: 50 km/mi)
            const goal = state.unit === 'km' ? 50 : 31; // 50 km or 31 miles
            const progress = Math.min((weeklyDistance / goal) * 100, 100);
            elements.progressBar.style.width = `${progress}%`;
            
            // For demo purposes, create some dummy leaderboard data
            const leaderboardData = [
                { name: "You", distance: weeklyDistance, isCurrentUser: true },
                { name: "Cyclist1", distance: weeklyDistance + 12.3 },
                { name: "BikeRider", distance: weeklyDistance + 8.7 },
                { name: "MountainBiker", distance: weeklyDistance + 5.2 },
                { name: "RoadMaster", distance: weeklyDistance + 18.9 }
            ].sort((a, b) => b.distance - a.distance);
            
            if (leaderboardData.length === 0) {
                elements.leaderboardList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-trophy text-4xl mb-2"></i>
                        <p>No leaderboard data yet</p>
                    </div>
                `;
                return;
            }
            
            elements.leaderboardList.innerHTML = '';
            leaderboardData.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = `p-3 rounded flex justify-between items-center ${item.isCurrentUser ? 'bg-blue-100 dark:bg-blue-900' : 'neumorph-inset dark:neumorph-inset-dark'}`;
                
                itemElement.innerHTML = `
                    <div class="flex items-center">
                        <span class="font-bold mr-2">${index + 1}.</span>
                        <span>${item.name}</span>
                    </div>
                    <span class="font-bold">${item.distance.toFixed(2)} ${state.unit}</span>
                `;
                
                elements.leaderboardList.appendChild(itemElement);
            });
        }

        // Save app settings
        function saveSettings() {
            const settings = {
                weight: parseInt(elements.weightInput.value) || 70,
                unit: elements.unitSelect.value,
                darkMode: state.darkMode
            };
            
            localStorage.setItem('cycleTrackerSettings', JSON.stringify(settings));
            
            // Update app state
            state.weight = settings.weight;
            state.unit = settings.unit;
            
            // Refresh displays to show updated units
            updateStats();
            updateHistoryList();
            updateLeaderboard();
        }

        // Load saved settings
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('cycleTrackerSettings') || '{}');
            
            if (settings.weight) {
                state.weight = settings.weight;
                elements.weightInput.value = settings.weight;
            }
            
            if (settings.unit) {
                state.unit = settings.unit;
                elements.unitSelect.value = settings.unit;
            }
            
            if (settings.darkMode) {
                state.darkMode = settings.darkMode;
                document.documentElement.classList.toggle('dark', state.darkMode);
                elements.themeToggle.innerHTML = state.darkMode ? 
                    '<i class="fas fa-sun text-yellow-300"></i>' : 
                    '<i class="fas fa-moon text-gray-700"></i>';
                
                if (elements.darkModeToggle) {
                    elements.darkModeToggle.checked = state.darkMode;
                }
            }
        }

        // Export ride data
        function exportData() {
            const rides = JSON.parse(localStorage.getItem('cycleTrackerRides') || '[]');
            const dataStr = JSON.stringify(rides, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'cyclerides.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Clear all data
        function clearData() {
            if (confirm('Are you sure you want to delete all ride data? This cannot be undone.')) {
                localStorage.removeItem('cycleTrackerRides');
                updateHistoryList();
                updateLeaderboard();
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>